<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart'Building - Dashboard Immeuble</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../design-system/tokens/colors.css">
  <link rel="stylesheet" href="../../design-system/tokens/typography.css">
  <link rel="stylesheet" href="../../design-system/tokens/spacing.css">
  <link rel="stylesheet" href="layout.css">
  <link rel="stylesheet" href="building.css">
  <script src="../shared/buildings-data.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <div class="logo-icon">
            <svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18l6.9 3.45L12 11.09 5.1 7.63 12 4.18zM4 8.82l7 3.5v7.36l-7-3.5V8.82zm9 10.86v-7.36l7-3.5v7.36l-7 3.5z"/></svg>
          </div>
          <div class="logo-text">Smart'<span>Building</span></div>
        </div>
      </div>
      
      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Navigation</div>
          <a href="../dashboard-parc/index.html" class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            Dashboard Parc
          </a>
          <div class="nav-item active">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            Bâtiment
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Exploitation</div>
          <div class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
            Énergie
          </div>
          <div class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
            Maintenance
            <span class="nav-badge" id="nav-maintenance-badge">3</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Système</div>
          <div class="nav-item">
            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
            Alertes
            <span class="nav-badge" id="nav-alerts-badge">7</span>
          </div>
        </div>
      </nav>

      <div class="sidebar-services">
        <div class="services-title">Services Actifs</div>
        <div class="service-card active">
          <div class="service-name">Smart'GTB</div>
          <div class="service-count">Hypervision technique</div>
        </div>
        <div class="service-card">
          <div class="service-name">Smart'Ecopilot</div>
          <div class="service-count">Management énergétique</div>
        </div>
      </div>

      <div class="sidebar-user">
        <div class="user-avatar">MD</div>
        <div class="user-info">
          <div class="user-name">Marc Dupont</div>
          <div class="user-role">Facility Manager</div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <!-- Header -->
      <header class="header">
        <a href="../dashboard-parc/index.html" class="header-back">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
          Retour au Parc
        </a>
        <div class="header-title">
          <h1>
            <span id="building-fullname">Chargement...</span>
            <span class="building-status" id="building-status">
              <span class="building-status-dot"></span>
              <span id="building-status-text">...</span>
            </span>
          </h1>
          <p><span id="building-address">...</span> • Dernière MAJ: il y a 2 min</p>
        </div>
        <div class="search-box">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
          <input type="text" placeholder="Rechercher zone, équipement...">
          <span class="search-shortcut">⌘K</span>
        </div>
        <div class="header-actions">
          <button class="header-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
            <span class="notification-dot"></span>
          </button>
          <button class="header-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
          </button>
        </div>
      </header>

      <!-- Content -->
      <div class="content">
        <!-- Building Info + Pulse -->
        <div class="building-info">
          <div class="building-details">
            <div class="building-detail">
              <span class="building-detail-label">Surface</span>
              <span class="building-detail-value" id="detail-surface">-</span>
            </div>
            <div class="building-detail">
              <span class="building-detail-label">Étages</span>
              <span class="building-detail-value" id="detail-floors">-</span>
            </div>
            <div class="building-detail">
              <span class="building-detail-label">Lots</span>
              <span class="building-detail-value" id="detail-units">-</span>
            </div>
            <div class="building-detail">
              <span class="building-detail-label">Équipements IoT</span>
              <span class="building-detail-value" id="detail-equipments">-</span>
            </div>
            <div class="building-detail">
              <span class="building-detail-label">DPE</span>
              <span class="building-detail-value" id="detail-dpe">-</span>
            </div>
          </div>
          <div class="building-pulse-container">
            <div class="building-pulse" id="building-pulse">
              <span class="building-pulse-score" id="pulse-score">--</span>
              <span class="building-pulse-label">Score Santé</span>
            </div>
            <div class="building-pulse-info">
              <div class="building-pulse-status" id="pulse-status">● ...</div>
              <div class="building-pulse-update">Mis à jour il y a 2 min</div>
            </div>
          </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs">
          <button class="tab active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
            Vue d'ensemble
          </button>
          <button class="tab">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            Énergie
          </button>
          <button class="tab">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
            Maintenance
            <span class="tab-badge" id="tab-maintenance-badge">3</span>
          </button>
          <button class="tab">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 6v6l4 2"/></svg>
            Confort
          </button>
          <button class="tab">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            Sécurité
          </button>
        </div>

        <!-- KPI Grid -->
        <div class="kpi-grid" id="kpi-grid">
          <!-- KPIs will be dynamically inserted here -->
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
          <!-- Structure Tree -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">Structure du Bâtiment</span>
              <a href="#" class="card-action">Voir plan →</a>
            </div>
            <div class="card-body card-body-flush">
              <div class="structure-tree" id="structure-tree">
                <!-- Zones will be dynamically inserted here -->
              </div>
            </div>
          </div>

          <!-- Alerts Sidebar -->
          <div class="card">
            <div class="card-header">
              <span class="card-title">Alertes Actives</span>
              <a href="#" class="card-action">Voir toutes →</a>
            </div>
            <div class="card-body card-body-flush">
              <div class="alerts-list" id="alerts-list">
                <!-- Alerts will be dynamically inserted here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Equipment Grid -->
        <div class="card" style="margin-top: 24px;">
          <div class="card-header">
            <span class="card-title">Équipements Principaux</span>
            <a href="#" class="card-action" id="equipments-count">Voir tous →</a>
          </div>
          <div class="equipment-grid" id="equipment-grid">
            <!-- Equipment cards will be dynamically inserted here -->
          </div>
        </div>

      </div>
    </main>
  </div>

  <script>
    // Get building ID from URL
    const buildingId = getBuildingIdFromUrl();
    const building = getBuildingById(buildingId);

    // If building not found, show error and redirect
    if (!building) {
      alert('Bâtiment non trouvé. Redirection vers le Dashboard Parc...');
      window.location.href = '../dashboard-parc/index.html';
    }

    // Update page title
    document.title = `Smart'Building - ${building.name} | Dashboard`;

    // Update header info
    document.getElementById('building-fullname').textContent = building.fullName;
    document.getElementById('building-address').textContent = building.address;
    
    // Update status
    const statusEl = document.getElementById('building-status');
    const statusTextEl = document.getElementById('building-status-text');
    statusEl.className = `building-status ${building.status === 'ok' ? 'ok' : building.status === 'warning' ? 'warning' : 'critical'}`;
    statusTextEl.textContent = building.status === 'ok' ? 'Opérationnel' : building.status === 'warning' ? 'Attention' : 'Critique';

    // Update building details
    document.getElementById('detail-surface').textContent = building.surface;
    document.getElementById('detail-floors').textContent = `${building.floors} niveaux`;
    document.getElementById('detail-units').textContent = `${building.units} logements`;
    document.getElementById('detail-equipments').textContent = `${building.equipments} actifs`;
    document.getElementById('detail-dpe').textContent = `Classe ${building.dpe}`;

    // Update Building Pulse
    const pulseEl = document.getElementById('building-pulse');
    document.getElementById('pulse-score').textContent = building.healthScore;
    document.getElementById('pulse-status').textContent = `● ${building.healthStatus}`;
    
    // Color pulse based on score
    if (building.healthScore >= 85) {
      pulseEl.style.borderColor = 'var(--color-success)';
      pulseEl.querySelector('.building-pulse-score').style.color = 'var(--color-success)';
    } else if (building.healthScore >= 70) {
      pulseEl.style.borderColor = 'var(--color-warning)';
      pulseEl.querySelector('.building-pulse-score').style.color = 'var(--color-warning)';
    } else {
      pulseEl.style.borderColor = 'var(--color-error)';
      pulseEl.querySelector('.building-pulse-score').style.color = 'var(--color-error)';
    }

    // Generate KPIs
    const kpiIcons = {
      consumption: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>',
      cost: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>',
      comfort: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 00-5 0v11.26a4.5 4.5 0 105 0z"/></svg>',
      maintenance: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>',
      co2: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M12 6v6l4 2"/></svg>'
    };
    const kpiLabels = {
      consumption: 'Conso. Électrique',
      cost: 'Coût Énergétique',
      comfort: 'Confort Moyen',
      maintenance: 'OT Ouverts',
      co2: 'Émissions CO2'
    };
    const kpiClasses = {
      consumption: 'energy',
      cost: 'cost',
      comfort: 'comfort',
      maintenance: 'maintenance',
      co2: 'carbon'
    };

    const kpiGrid = document.getElementById('kpi-grid');
    Object.entries(building.kpis).forEach(([key, kpi]) => {
      const kpiCard = document.createElement('div');
      kpiCard.className = 'kpi-card';
      kpiCard.innerHTML = `
        <div class="kpi-header">
          <div class="kpi-icon ${kpiClasses[key]}">${kpiIcons[key]}</div>
          <span class="kpi-label">${kpiLabels[key]}</span>
        </div>
        <div class="kpi-value">${kpi.value} ${kpi.unit}</div>
        <div class="kpi-trend">
          <span class="kpi-trend-badge ${kpi.trendType}">${kpi.trend}</span>
          <span class="kpi-trend-period">${kpi.period}</span>
        </div>
      `;
      kpiGrid.appendChild(kpiCard);
    });

    // Update maintenance badge
    const maintenanceCount = building.kpis.maintenance.value;
    document.getElementById('nav-maintenance-badge').textContent = maintenanceCount;
    document.getElementById('tab-maintenance-badge').textContent = maintenanceCount;

    // Generate structure tree
    const structureTree = document.getElementById('structure-tree');
    building.zones.forEach((zone, index) => {
      const statusClass = zone.status === 'ok' ? 'ok' : zone.status === 'warning' ? 'warning' : 'critical';
      const zoneEl = document.createElement('div');
      zoneEl.className = `structure-item ${index === 0 ? 'open' : ''}`;
      zoneEl.onclick = function() { this.classList.toggle('open'); };
      zoneEl.innerHTML = `
        <div class="structure-expand ${index === 0 ? 'open' : ''}">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
        </div>
        <div class="structure-icon zone">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
        </div>
        <div class="structure-info">
          <div class="structure-name">${zone.name}</div>
          <div class="structure-meta"><span>${zone.floors} • ${zone.equipments} équipements</span></div>
        </div>
        <div class="structure-status">
          <span class="structure-status-dot ${statusClass}"></span>
        </div>
      `;
      structureTree.appendChild(zoneEl);
    });

    // Generate alerts list
    const alertsList = document.getElementById('alerts-list');
    building.alerts.forEach(alert => {
      const alertEl = document.createElement('div');
      alertEl.className = 'alert-item';
      alertEl.innerHTML = `
        <div class="alert-severity ${alert.severity}"></div>
        <div class="alert-content">
          <div class="alert-title">${alert.title}</div>
          <div class="alert-meta">${alert.meta}</div>
        </div>
        <div class="alert-time">${alert.time}</div>
      `;
      alertsList.appendChild(alertEl);
    });

    // Update alerts badge
    const alertsCount = building.alerts.filter(a => a.severity === 'critical' || a.severity === 'warning').length;
    document.getElementById('nav-alerts-badge').textContent = alertsCount;

    // Generate equipment cards
    const equipmentGrid = document.getElementById('equipment-grid');
    document.getElementById('equipments-count').textContent = `Voir tous (${building.equipments}) →`;
    
    const equipmentIcons = {
      'Centrale de Traitement d\'Air': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>',
      'Chaudière Gaz Condensation': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 00-5 0v11.26a4.5 4.5 0 105 0z"/></svg>',
      'Chaudière Gaz': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 00-5 0v11.26a4.5 4.5 0 105 0z"/></svg>',
      'Ascenseur Principal': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>',
      'Ascenseur Secondaire': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>',
      'Ascenseur': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>',
      'Tableau Général Basse Tension': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>',
      'Système Sécurité Incendie': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
      'Pompe à Chaleur': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
      'Pompe à Chaleur Réversible': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
      'Pompe à Chaleur Géothermique': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
      'Installation Photovoltaïque': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/></svg>',
      'Batterie de Stockage': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="18" height="10" rx="2" ry="2"/><line x1="22" y1="11" x2="22" y2="13"/><line x1="6" y1="11" x2="6" y2="13"/><line x1="10" y1="11" x2="10" y2="13"/><line x1="14" y1="11" x2="14" y2="13"/></svg>',
      'VMC Double Flux': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20"/></svg>',
      'Gestion Technique Centralisée': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>'
    };

    building.equipmentsList.forEach(equipment => {
      const icon = equipmentIcons[equipment.type] || '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>';
      const statusClass = equipment.status === 'error' ? 'error' : 'running';
      
      const equipmentCard = document.createElement('div');
      equipmentCard.className = 'equipment-card';
      equipmentCard.onclick = function() { alert('Ouvrir fiche équipement: ' + equipment.name); };
      equipmentCard.innerHTML = `
        <div class="equipment-header">
          <div class="equipment-icon">${icon}</div>
          <span class="equipment-status ${statusClass}">● ${equipment.statusText}</span>
        </div>
        <div class="equipment-name">${equipment.name}</div>
        <div class="equipment-type">${equipment.type}</div>
        <div class="equipment-metrics">
          ${equipment.metrics.map(m => `
            <div class="equipment-metric">
              <span class="equipment-metric-value">${m.value}</span>
              <span class="equipment-metric-label">${m.label}</span>
            </div>
          `).join('')}
        </div>
      `;
      equipmentGrid.appendChild(equipmentCard);
    });

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
      });
    });
  </script>
</body>
</html>